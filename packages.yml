packages:
  - name: mlibc-headers
    version: '5.0'
    from_source: mlibc
    system-package: true
    metadata:
      summary: Managarm libc headers
      description: This package provides the headers for the C standard library that Hades uses.
      essential: true

      website: 'https://github.com/managarm/mlibc'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--prefix=/usr'
        - '-Dheaders_only=true'
        - '--cross-file'
        - '@SOURCE_ROOT@/cross_file.txt'

        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: mlibc
    version: '5.0'
    from_source: mlibc
    tools-required:
      - tool: host-gcc
        stage-dependencies: [compiler]
    system-package: true
    metadata:
      summary: Managarm libc C library
      description: This package provides the C standard library that Hades uses, this includes the dynamic loader and various utility libraries.
      essential: true

      website: 'https://github.com/managarm/mlibc'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    pkgs-required:
      - mlibc-headers
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--buildtype=debugoptimized'
        - '--prefix=/usr'
        - '--cross-file'
        - '@SOURCE_ROOT@/cross_file.txt'
        - '-Ddisable_libgcc_dependency=true'
        - '-Dmlibc_no_headers=true'

        - '@THIS_SOURCE_DIR@'
        environ:
          LDFLAGS: '-Wl,@THIS_SOURCE_DIR@/binaries/libgcc-x86_64.a'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: bash
    version: '5.1'
    from_source: bash
    metadata:
      summary: The standard GNU Bourne again shell
      description: This package provides the Bourne-Again SHell.
      website: 'https://tiswww.case.edu/php/chet/bash/bashtop.html'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    tools-required:
      - host-autoconf
      - host-automake
      - host-gcc
    pkgs-required:
      - ncurses
      - readline
      - iconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--without-bash-malloc'
        - '--disable-nls'
        - '--with-installed-readline=$SYSROOT_DIR$/usr'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']

  - name: coreutils
    version: '9.5'
    from_source: coreutils
    metadata:
      summary: GNU core utilities
      description:  This package contains the basic file, shell and text manipulation utilities which are expected to exist on every operating system.

      website: 'https://www.gnu.org/software/coreutils/'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    tools-required:
      - host-gcc
    configure:
      # Huge hack: coreutils does not compile the build-machine binary make-prime-list
      # using the build-machine compiler. Hence, build and invoke the binary manually here.
      - args: ['@THIS_SOURCE_DIR@/configure']
      - args: ['make', 'src/make-prime-list']
      - args: ['./src/make-prime-list 5000 > @THIS_SOURCE_DIR@/src/primes.h']
        shell: True
      - args: ['make', 'clean']

      # Now compile coreutils for the correct target.
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        environ:
          CLFAGS: '-DSLOW_BUT_NO_HACKS -Wno-error'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: iconv
    version: '1.17'
    from_source: iconv
    metadata:
      summary: GNU charset conversion library for libc which doesn't implement it
      description: GNU charset conversion library for libc which doesn't implement it

      website: 'https://www.gnu.org/software/libiconv/'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: libs
    tools-required:
      - host-gcc
      - host-libtool
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@'
        - '--disable-nls'
        - '--enable-shared'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: ncurses
    version: '6.2'
    from_source: ncurses
    metadata:
      summary: Libary for terminal handling
      description:  The ncurses library routines are a terminal-independent method of updating character screens with reasonable optimization.

      website: 'https://invisible-island.net/ncurses/'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: libs
    tools-required:
      - host-gcc
      - host-tic
      - host-automake
      - host-autoconf
      - host-pkg-config
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--without-ada'
        - '--enable-pc-files'
        - '--with-shared'
        - '--without-normal'
        - '--with-manpage-format=normal'
        - '--with-pkg-config-libdir=/usr/lib/pkgconfig'
        - '--with-termlib'
        - '--enable-widec'
        environ:
          cf_cv_func_nanosleep: 'yes'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
      - args:
          - |
              for lib in ncurses form panel menu tinfo ; do
                  rm -vf                    @THIS_COLLECT_DIR@/usr/lib/lib${lib}.so
                  echo "INPUT(-l${lib}w)" > @THIS_COLLECT_DIR@/usr/lib/lib${lib}.so
                  ln -sfv ${lib}w.pc        @THIS_COLLECT_DIR@/usr/lib/pkgconfig/${lib}.pc
              done
              rm -vf                     @THIS_COLLECT_DIR@/usr/lib/libcursesw.so
              echo "INPUT(-lncursesw)" > @THIS_COLLECT_DIR@/usr/lib/libcursesw.so
              ln -sfv libncurses.so      @THIS_COLLECT_DIR@/usr/lib/libcurses.so
        shell: True

  - name: readline
    version: '8.1'
    from_source: readline
    metadata:
      summary: GNU readline and history libraries
      description:  The GNU readline library aids in the consistency of user interface across discrete programs that need to provide a command line interface. 

      website: 'https://tiswww.case.edu/php/chet/readline/rltop.html'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: libs
    tools-required:
      - host-gcc
    pkgs-required:
      - ncurses
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--enable-multibyte'
        - '--with-curses'
    build:
      - args: ['make', 'SHLIB_LIBS="-lncursesw"', '-j@PARALLELISM@']
      - args: ['make', 'SHLIB_LIBS="-lncursesw"', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['patchelf', '--set-soname', 'libreadline.so.8', '@THIS_COLLECT_DIR@/usr/lib/libreadline.so.8']
      - args: ['patchelf', '--set-soname', 'libhistory.so.8', '@THIS_COLLECT_DIR@/usr/lib/libhistory.so.8']

  - name: zlib
    version: '1.2.12'
    from_source: zlib
    metadata:
      summary: Standard (de)compression library
      description: This package provides some common compression and decompression functions used by various programs.

      website: 'https://zlib.net'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    tools-required:
      - host-gcc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=/usr'
        environ:
          CHOST: '@TARGET@'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['patchelf', '--set-soname', 'libz.so.1.2.12', '@THIS_COLLECT_DIR@/usr/lib/libz.so.1.2.12']

  - name: xz-utils
    version: '5.4.4'
    from_source: xz-utils
    metadata:
      summary: Utilities for managing LZMA compressed files
      description: This package provides the programs to compress and decompress lzma and xz compressed files.

      website: 'https://tukaani.org/xz'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: utils
    tools-required:
      - host-automake
      - host-autoconf
      - host-libtool
      - host-gcc
    pkgs-required:
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--disable-static'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: openssl
    version: '1.1.1'
    from_source: openssl
    metadata:
      summary: Secure Sockets Layer toolkit
      description: This package provides the OpenSSL project's implementation of the SSL and TLS cryptographic protocols for secure communication over the Internet. 

      website: 'https://www.openssl.org'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: crypt
    tools-required:
      - host-gcc
    pkgs-required:
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/Configure'
        - '--prefix=/usr'
        - '--openssldir=/etc/ssl'
        - '--libdir=lib'
        - '@TARGET@'
        - 'shared'
        - 'zlib-dynamic'
        - 'no-afalgeng'
        environ:
          CC: '@TARGET@-gcc'
          CXX: '@TARGET@-g++'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['sed', '-i', '/INSTALL_LIBS/s/libcrypto.a libssl.a//', 'Makefile']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'MANSUFFIX=ssl', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['cp', '-fr', '@THIS_SOURCE_DIR@/doc/.', '@THIS_COLLECT_DIR@/usr/share/doc/openssl']

  - name: libmd
    version: '1.1.0'
    from_source: libmd
    metadata:
      summary: Provides message digest functions from BSD systems
      description:  The libmd library provides various message digest ("hash") functions, as found on various BSDs on a library with the same name and with a compatible API. 

      website: 'https://www.hadrons.org/software/libmd'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: libs
    tools-required:
      - host-gcc
      - host-libtool
      - host-pkg-config
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: dpkg
    version: '1.22.11'
    from_source: dpkg
    metadata:
      summary: Debian package management system, ported to Hades
      description:  This package provides the low-level infrastructure for handling the installation and removal of Hades software packages. 
      essential: true

      website: 'https://www.dpkg.org'
      maintainer: 'Yavuz Rao <racemus@hades-os.org>'
      section: core
    tools-required:
      - host-gcc
      - host-libtool
      - host-pkg-config
    pkgs-required:
      - libmd
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@TARGET@'
        - '--prefix=/usr'
        - '--disable-dselect'
        - '--disable-start-stop-daemon'
        - '--disable-update-alternatives'
        - '--disable-largefile'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
#
#  - name: binutils
#    version: '2.43'
#    from_source: binutils
#    tools-required:
#      - tool: host-gcc
#    configure:
#      - args:
#        - '@THIS_SOURCE_DIR@/configure'
#        - '--host=@TARGET@'
#        - '--prefix=/usr'
#        - '--target=@TARGET@'
#        - '--with-sysroot=/'
#        - '--disable-nls'
#        # On recent compilers, binutils 2.26 causes implicit-fallthrough warnings, among others.
#        - '--disable-werror'
#        # -g blows up the binary size.
#        - 'CFLAGS=-O2 -pipe'
#    build:
#      - args: ['make', '-j@PARALLELISM@']
#      - args: ['make', 'install']
#        environ:
#          DESTDIR: '@THIS_COLLECT_DIR@'
#        quiet: true